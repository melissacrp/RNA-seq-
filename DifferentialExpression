## Gene-level differential expression analysis using edgeR - based of arabdesign

if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install(version = "3.12")

if (!requireNamespace("BiocManager", quietly = TRUE))
  install.packages("BiocManager")
BiocManager::install()
BiocManager::install("edgeR")



BiocManager::install("limma")

install.packages("statmod")
library(edgeR)
getwd()


#common info
matrixDGA <- read.delim(file = "/Users/melissa/Desktop/Transcriptomics&Bioinformatics | Thesis/counts/clean_banana_featurecounts.txt", header = TRUE, 
                        sep=" ")
Cultivar <- factor(c("T","T","T","T","T","T","W","W","W","W","W","W"))
tpi <- factor(c("6h","12h","24h","72h","144h","168h","6h","12h","24h","72h","144h","168h")) #C is 6-12h with mock
colnames(matrixDGA) = c("Gene ID","CT6-12h","T12h","T24h","T3d","T6d","T7d","CW6-12h","W12h","W24h","W3d","W6d","W7d")
types <- factor(c("A","B","C","D","E","F","G","H","I","J","K","L")) #just to differentiate the groups

#here need to account for no replicatesr
y <- DGEList(counts=matrixDGA[,2:13], genes=matrixDGA[,1],group = types)

#create conditions matrix
targets <- data.frame(Sample = colnames(y),Cultivar,tpi)
Group <- factor(paste(targets$Cultivar,targets$tpi,sep="."))
cbind(targets,Group=Group)
keep <- filterByExpr(y) #keeps rows that have worthwhile counts in a minumum number of samples (two samples in this case because the smallest group size is two
table(keep)
y <- y[keep, , keep.lib.sizes=FALSE] #filtrar los que no tienen un nivel significativo de expresion
y <- calcNormFactors(y)
y$samples

plotMDS(y) #data exploration

#design matrix
design <- model.matrix(~0+Group)
colnames(design) <- levels(Group)
bcv <- 0.2
fit <- glmFit(y, design, dispersion = bcv^2)

#likelihood (it was changed)
lrt <- glmLRT(fit,coef=2)
topTags(lrt)

#Comparing all the groups


#pathogen effect and show the top genes
qlf <- glmLRT(fit)
topTags(qlf)
#counts-per-million for the top gene
top <- rownames(topTags(qlf))
cpm(y)[top,]
#The total number of genes significantly up-regulated or down-regulated at 5% FDR
summary(decideTests(qlf))
plotMD(qlf)
abline(h=c(-1,1), col="blue")















